function doGet(e) {
  return handleOptions(e);
}

function doPost(e) {
  try {
    // Parse JSON body
    const data = JSON.parse(e.postData.contents);

    if (data.action === 'recordAttendance') {
      const sheetName = data.sheetName || 'Default';
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      let sheet = ss.getSheetByName(sheetName);

      // Create sheet if it doesn't exist
      if (!sheet) {
        sheet = ss.insertSheet(sheetName);
        sheet.appendRow([
          "SrNo",
          "EnrollmentNo",
          "FirstName",
          "MiddleName",
          "LastName",
          "StudentMobNo",
          "EmailId",
          "CurrentDegree",
          "Coordinator",
          "Timestamp",
          "Method",
          "Status"
        ]);
      }

      const s = data.student;
      sheet.appendRow([
        s.srNo,
        s.enrollment,
        s.firstName,
        s.middleName,
        s.lastName,
        s.mobile,
        s.email,
        s.degree,
        data.coordinator,
        data.timestamp,
        data.method,
        "Present"
      ]);

      return addCorsHeaders(
        ContentService.createTextOutput(
          JSON.stringify({ success: true, message: "Attendance recorded" })
        ).setMimeType(ContentService.MimeType.JSON)
      );
    }

    // Default response if action is unknown
    return addCorsHeaders(
      ContentService.createTextOutput(
        JSON.stringify({ success: false, message: "Unknown action" })
      ).setMimeType(ContentService.MimeType.JSON)
    );

  } catch (err) {
    return addCorsHeaders(
      ContentService.createTextOutput(
        JSON.stringify({ success: false, error: err.message })
      ).setMimeType(ContentService.MimeType.JSON)
    );
  }
}

// Handle OPTIONS requests (CORS preflight)
function handleOptions(e) {
  if (e && e.method && e.method === "OPTIONS") {
    return addCorsHeaders(ContentService.createTextOutput(""));
  }
  return addCorsHeaders(ContentService.createTextOutput("OK"));
}

// Add CORS headers to all responses
function addCorsHeaders(output) {
  return output
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}
